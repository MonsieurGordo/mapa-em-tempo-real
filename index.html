<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Dispositivos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    /* Estilos gerais */
    body { margin: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; width: 100%; }

    /* Estilos do menu lateral */
    #sidebar {
      position: fixed;
      top: 0; left: 0;
      height: 100%;
      width: 250px;
      background: #333;
      color: white;
      padding: 1rem;
      overflow-y: auto;
      transition: width 0.3s;
    }
    #sidebar.minimized { width: 40px; }
    #sidebar h2 { margin-top: 0; }
    #sidebar button { margin: 5px 0; width: 100%; }
    #toggleSidebar {
      position: absolute;
      top: 10px;
      right: -30px;
      background: #333;
      color: white;
      border: none;
      padding: 5px;
      cursor: pointer;
    }

    #mapContainer { margin-left: 250px; transition: margin-left 0.3s; }
    #sidebar.minimized + #mapContainer { margin-left: 40px; }

    .label-marker {
      background: white;
      padding: 2px 4px;
      border: 1px solid #ccc;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <button id="toggleSidebar">⇔</button>
    <h2>Menu</h2>
    <button onclick="showTab('localizacoes')">Localizações</button>
    <button onclick="showTab('historico')">Histórico</button>
    <button onclick="showTab('rota')">Criar Rota</button>
    <div id="filtros"></div>
  </div>

  <div id="mapContainer">
    <div id="map"></div>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Dados simulados — Substitua isso por sua leitura do Google Sheets ou backend
    const localizacoes = [
      { nome: "Dispositivo 1", status: "Ativo", lat: -15.6, lng: -56.1, protocolo: "123", datahora: "2024-06-01 08:00", endereco: "Rua A", estado: "MT", observacoes: "" },
      { nome: "Dispositivo 2", status: "Inativo", lat: -15.61, lng: -56.11, protocolo: "", datahora: "2024-06-01 09:00", endereco: "Rua B", estado: "MT", observacoes: "N/A" },
    ];

    const historico = [
      { id: 1, nome: "Equipe A", datahora: "2024-06-01 10:00", lat: -15.6, lng: -56.1, protocolo: "321" },
      { id: 2, nome: "Equipe B", datahora: "2024-06-01 10:05", lat: -15.599, lng: -56.09, protocolo: "654" },
    ];

    let map = L.map('map').setView([-15.6, -56.1], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];

    function clearMarkers() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
    }

    function showTab(tab) {
      clearMarkers();
      document.getElementById("filtros").innerHTML = "";

      if (tab === 'localizacoes') {
        showLocalizacoes();
      } else if (tab === 'historico') {
        showHistorico();
      } else if (tab === 'rota') {
        showRota();
      }
    }

    // Função Localizações
    function showLocalizacoes() {
      localizacoes.forEach(d => {
        const iconColor = d.status === "Ativo" ? "blue" : "red";
        const marker = L.circleMarker([d.lat, d.lng], {
          radius: 8,
          color: iconColor,
          fillColor: iconColor,
          fillOpacity: 1
        }).addTo(map);

        L.marker([d.lat, d.lng], {
          icon: L.divIcon({
            className: 'label-marker',
            html: d.nome,
            iconSize: [100, 20],
            iconAnchor: [50, 20]
          })
        }).addTo(map);

        marker.bindPopup(`
          <strong>${d.nome}</strong><br>
          Data/Hora: ${d.datahora}<br>
          Latitude: ${d.lat}<br>
          Longitude: ${d.lng}<br>
          Endereço: ${d.endereco}<br>
          Estado: ${d.estado}<br>
          Protocolo: ${d.protocolo}<br>
          Status: ${d.status}<br>
          Observações: ${d.observacoes}
        `);
        markers.push(marker);
      });
    }

    // Função Histórico
    function showHistorico() {
      const container = document.getElementById("filtros");
      container.innerHTML = `
        <label>Coordenadas (lat,lng): <input id="coord" /></label><br>
        <label>Data (opcional): <input id="data" type="date" /></label>
        <button onclick="filtrarHistorico()">Pesquisar</button>
      `;
    }

    function filtrarHistorico() {
      clearMarkers();
      const [lat, lng] = document.getElementById("coord").value.split(',').map(Number);

      historico.forEach(d => {
        const dist = map.distance([lat, lng], [d.lat, d.lng]);
        if (dist <= 1000) {
          const marker = L.circleMarker([d.lat, d.lng], {
            radius: 8,
            color: 'purple',
            fillColor: 'purple',
            fillOpacity: 1
          }).addTo(map);

          marker.bindPopup(`
            ID: ${d.id}<br>
            Nome/Equipe: ${d.nome}<br>
            DataHora: ${d.datahora}<br>
            Latitude: ${d.lat}<br>
            Longitude: ${d.lng}<br>
            Protocolo: ${d.protocolo}
          `);

          markers.push(marker);
        }
      });
    }

    // Função Rota
    function showRota() {
      const container = document.getElementById("filtros");
      container.innerHTML = `
        <label>Destino (lat,lng): <input id="rotaCoord" /></label>
        <button onclick="calcularRota()">Calcular</button>
      `;

      // Exibir todos os dispositivos inicialmente
      showLocalizacoes();
    }

    function calcularRota() {
      clearMarkers();
      const [lat, lng] = document.getElementById("rotaCoord").value.split(',').map(Number);

      L.marker([lat, lng], { title: 'Destino' }).addTo(map);
      map.setView([lat, lng], 15);

      const distancias = localizacoes.map((d, i) => ({
        index: i,
        distancia: map.distance([lat, lng], [d.lat, d.lng])
      })).sort((a, b) => a.distancia - b.distancia);

      localizacoes.forEach((d, i) => {
        let color = d.status === 'Ativo' ? 'blue' : 'red';
        if (i === distancias[0].index) color = 'green';
        else if (i === distancias[1].index) color = 'orange';

        const marker = L.circleMarker([d.lat, d.lng], {
          radius: 8,
          color,
          fillColor: color,
          fillOpacity: 1
        }).addTo(map);

        L.marker([d.lat, d.lng], {
          icon: L.divIcon({
            className: 'label-marker',
            html: d.nome,
            iconSize: [100, 20],
            iconAnchor: [50, 20]
          })
        }).addTo(map);

        markers.push(marker);
      });
    }

    // Sidebar toggle
    document.getElementById("toggleSidebar").onclick = () => {
      document.getElementById("sidebar").classList.toggle("minimized");
      document.getElementById("mapContainer").classList.toggle("minimized");
    };

    // Atualização automática a cada 60 segundos
    setInterval(() => {
      if (currentTab === 'localizacoes') showLocalizacoes();
    }, 60000);

    let currentTab = 'localizacoes';
    showTab(currentTab);
  </script>
</body>
</html>
